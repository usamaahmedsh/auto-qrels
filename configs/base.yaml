dataset:
  name: "wiki"

  corpus:
    name: "usamaahmedsh/wiki-synthetic-prepared-corpus"
    split: "train"
    text_field: "text"
    id_field: "doc_id"

  queries:
    name: "usamaahmedsh/wiki-synthetic-prepared-queries"
    split: "train"
    text_field: "text"
    id_field: "query_id"

paths:
  prepared_dir: "data/prepared"
  hf_cache_dir: "data/hf_cache"
  passages_dir: "data/passages"
  indexes_dir: "data/indexes"
  phase1_prompts_path: "data/prepared/judge_prompts.jsonl"
  output_dir: "data/output"

corpus:
  passage_tokens: 256
  passage_stride: 128

  min_chunk_tokens: 30
  min_alpha_ratio: 0.5
  dedupe_hash_length: 200
  use_semantic_dedup: false
  semantic_threshold: 0.95
  device: "cuda"

bm25:
  k1: 0.9
  b: 0.4

  method: "lucene"
  stopwords: "en"
  use_stemmer: true

  index_name: "bm25s"
  mmap: true
  load_corpus: true

  num_threads: 8
  batch_size: 2048

  passage_text_field: "text"
  passage_id_field: "doc_id"

dense:
  model_name: "BAAI/bge-base-en-v1.5"
  device: "cuda"
  batch_size: 12288
  normalize_embeddings: true
  cache_queries: true
  max_query_cache_size: 800000
  use_fp16: true
  show_progress: false
  index_path: "data/indexes/passage_embs.npz"

cross_encoder:
  model_name: "cross-encoder/ms-marco-MiniLM-L-6-v2"
  device: "cuda:0"
  batch_size: 8192
  max_length: 512
  use_fp16: true
  show_progress: false

llm:
  base_url: "http://127.0.0.1:8000/v1/chat/completions"
  model: "Qwen/Qwen2.5-7B-Instruct"

  timeout_total: 180.0
  timeout_connect: 10.0
  timeout_read: 180.0
  timeout_write: 10.0
  timeout_pool: 10.0

  max_retries: 3
  retry_backoff_s: 0.05

  max_concurrent_requests: 1024
  passages_per_request: 1
  passage_chars: 800

  guided:
    mode: "choice"
    choices: ["YES", "NO"]

  httpx:
    max_connections: 2048
    max_keepalive_connections: 2048
    keepalive_expiry_s: 30.0

  cache:
    enabled: true
    db_path: "data/prepared/llm_cache.db"
    sqlite:
      journal_mode: "WAL"
      synchronous: "NORMAL"
      busy_timeout_ms: 30000
      cache_size_kb: 524288
      temp_store: "MEMORY"

agent:
  batch_size: 4096
  concurrent_queries: 8
  checkpoint_dir: "data/checkpoints"
  checkpoint_interval: 100
  max_queries: null

  global_top_k_bm25: 1500
  dense_top_k_from_bm25: 600

  use_cross_encoder: true
  cross_encoder_top_k: 150
  llm_candidates_top_k: 80
  llm_conf_threshold: 0.0

  positives_max: 10
  triplet_positives_max: 1

  hard_negatives_per_query: 40
  negs_per_positive: 16
  export_listwise: false

  # ----------------------------
  # Phase 3: rank-windowed negs
  # ----------------------------
  min_hard_rank: 10
  max_hard_rank: 30

  # Disable semi-hard until hard pool is clean
  add_semi_hard: false
  semi_hard_per_positive: 0
  min_semi_rank: 51
  max_semi_rank: 80

  # ----------------------------
  # Phase 3: near-dup filtering
  # ----------------------------
  enable_near_dup_filter: true
  near_dup_ngrams: 5
  near_dup_threshold: 0.92
  near_dup_max_chars: 1200

  # --------------------------------
  # Phase 3: negative quality filters
  # --------------------------------
  enable_neg_quality_filter: true
  min_neg_chars: 200
  min_neg_alpha_ratio: 0.65

  # -----------------------------------------------
  # Phase 3: dynamic posdoc-signature overlap gate
  # -----------------------------------------------
  enable_signature_gate: true
  idf_path: "artifacts/idf.json"   # token->idf (lowercased)
  idf_default: 0.0

  signature_top_k: 12
  signature_token_min_len: 5
  signature_idf_min: 5.0
  signature_min_terms: 4
  signature_fallback_idf_min: 4.0

  min_shared_signature_terms: 2

  # Disable old query-negative overlap gate (replaced by signature gate)
  min_shared_query_terms: 0
  overlap_token_min_len: 4

  # (kept)
  min_query_token_len: 3
  min_passage_tokens: 30
  max_passages_per_page: 4

  device: "cuda"
  dense_batch_size: 12288
  cross_encoder_batch_size: 8192

output:
  qrels_path: "data/output/qrels.tsv"
  triples_path: "data/output/triples.jsonl"

logging:
  log_dir: "logs"
  level: "INFO"
  log_file: "agent.log"
  rotation: "100 MB"
  retention: "7 days"

